name: Test
on: [push, workflow_dispatch]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup docker
        shell: bash
        run: |
          docker-compose build
          docker-compose up -d
        env:
          RAILS_ENV: test

      - name: sleep for waiting launch db
        run: sleep 1m

      - name: setup db
        run: docker-compose run --rm web rails db:create db:migrate

      - name: Run Rspec
        run:  |
          docker-compose run web bundle exec rspec

      - name: Run Rubocop
        run:  |
          docker-compose run web bundle exec rubocop

      - name: docker-compose down
        run: docker-compose down

  deploy:
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build and push Rails Docker image
        uses: docker/build-push-action@v2
        with:
          context: ../../nature-sounds-app/nature-sounds-app
          file: ../../nature-sounds-app/nature-sounds-app/dockerfile
          push: true
          tags: ${{ steps.login-ecr.outputs.registry }}/my_ecr_repo:rails_latest

      - name: Build and push Nginx Docker image
        uses: docker/build-push-action@v2
        with:
          context: ../../nature-sounds-app/nature-sounds-app/.nginx
          file: ../../nature-sounds-app/nature-sounds-app/.nginx/dockerfile
          push: true
          tags: ${{ steps.login-ecr.outputs.registry }}/my_ecr_repo:nginx_latest
